<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/layout/header::oceanHead('kakaopay실험')}"></head>
<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
<script>
$(function(){
	$("#kakaopayTest").on('sunmit', function(){
		
		// 필수입력값을 확인.
		var name = $("#kakaopayTest input[name='pay-name']").val();
		var tel = $("#kakaopayTest input[name='pay-tel']").val();
		var email = $("#kakaopayTest input[name='pay-email']").val();
		/* 		
		if(name == ""){
			$("#form-payment input[name='pay-name']").focus()
		}
		if(tel == ""){
			$("#form-payment input[name='pay-tel']").focus()
		}
		if(email == ""){
			$("#form-payment input[name='pay-email']").focus()
		} */
		
		// 결제 정보를 form에 저장한다.
		/* 
		let totalPayPrice = parseInt($("#total-pay-price").text().replace(/,/g,''))
		let totalPrice = parseInt($("#total-price").text().replace(/,/g,''))
		let discountPrice = totalPrice - totalPayPrice 
		let usePoint = $("#point-use").val()
		let useUserCouponNo = $(":radio[name='userCoupon']:checked").val() 
		*/
		var totalPayPrice = 100;
		var totalPrice = 100;
		// 카카오페이 결제전송
		$.ajax({
			type:'post'
			,url:'/semiOrder/pay'
			,data:{
				total_amount: totalPayPrice
				,payUserName: name
				,totalPrice:totalPayPrice
				,tel:tel
				,email:email
				
			},
			success : 
				function(resData){
					
					var url = resData.next_redirect_pc_url
					location.href = url;
				}
		})
	})
})


/* ******************* 아임포트 ************************** */
IMP.init("imp34850056"); // 예: imp00000000a

function requestPay() {
    IMP.request_pay({
      pg: "kcp.store-04ae1711-468b-4691-b19b-48e00dbc9948",
      pay_method: "card",
      merchant_uid: "ORD20180131-0000011",   // 주문번호
      name: "민쌤의 커피머신^^",
      amount: 23432000,                         // 숫자 타입
      buyer_email: $("#kakaopayTest input[name='pay-email']").val(),
      buyer_name: $("#kakaopayTest input[name='pay-name']").val(),
      buyer_tel: $("#kakaopayTest input[name='pay-tel']").val(),
      buyer_addr: "서울특별시 강남구 신사동",
      buyer_postcode: "01181"
    }, function (rsp) { // callback
      //rsp.imp_uid 값으로 결제 단건조회 API를 호출하여 결제결과를 판단합니다.
   	  rsp => {
   		    if (rsp.success) {   
   		      // axios로 HTTP 요청
   		      ajax({
   		        url: "/api/v1/payment/complete",
   		        method: "post",
   		        headers: { "Content-Type": "application/json" },
   		        data: {
   		          imp_uid: rsp.imp_uid,
   		          merchant_uid: rsp.merchant_uid
   		        }
   		      }).then((data) => {
   		        location.replace('/semiOrder/kakaopayCompleted');
   		       	
   		      })
   		    } else {
   		      alert(`결제에 실패하였습니다. 에러 내용: ${rsp.error_msg}`);
   		    }
   		}
    })
}
</script>
<body>

	<!-- ---------------카카오 페이 ------------------ -->
	<form action="/semiOrder/pay" method="post" id="kakaopayTest">
		<label>이름</label>
		<input type="text" name="pay-name">
		<label>전화번호</label>
		<input type="tel" name="pay-tel">
		<label>이메일</label>
		<input type="text" name="pay-email">
		
		<button>성공기원</button>
	</form>
	<!-- ----------------- 아임포트 ------------------ -->
	 <button onclick="requestPay()">결제하기</button>
</body>
</html>