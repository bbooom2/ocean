<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/layout/header::oceanHead('주문하기')}"></head>
<!--  아임포트 라이브러리 -->
<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
<!--  주소 라이브러리 -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<style>
	body {
		
	}
	.container {
		display: flex;
	}
</style>
<script>
/* ***************** 주소 ****************** */

function execDaumPostcode() {
		new daum.Postcode({
			oncomplete: function(data) {
				var roadAddr = data.roadAddress; // 도로명 주소 변수

				document.getElementById('buyer_addr').value = data.zonecode;
				document.getElementById("buyer_addr2").value = roadAddr;

				var guideTextBox = document.getElementById("guide");
				if(data.autoRoadAddress) {
					var expRoadAddr = data.autoRoadAddress + extraRoadAddr;
					guideTextBox.innerHTML = '(예상 도로명 주소 : ' + expRoadAddr + ')';
					guideTextBox.style.display = 'block';
				} else {
					guideTextBox.innerHTML = '';
					guideTextBox.style.display= 'none';
			}
		}
	}).open();
}


/* ******************* 아임포트 ************************** */

/*
 * 주문번호 무작위 생성 메소드 
 */
function createOrderNum() {
	const date = new Date();
	const year = date.getFullYear();
	const month = String(date.getMonth() + 1).padStart(2, "0");
	const day = String(date.getDate()).padStart(2, "0");
	
	let orderNum = year + month + day;
	for(let i=0;i<10;i++) {
		orderNum += Math.floor(Math.random() * 8);	
	}
	return orderNum;
}
$('#kakaopayBtn').on('submit', function() {
	
	const data = {
		orderNum : createOrderNum(),
		name : $("#iamportTest input[name='buyer_name']").val(),
		email : $("#iamportTest input[name='buyer_email']").val(),
		phone : $("#iamportTest input[name='buyer_tel']").val(),
		postcode : $("#iamportTest input[name='postcode']").val(),
		address : $("#iamportTest input[name='roadAddress']").val() + $("#iamportTest input[name='detailAddress']").val(),
		totalPayPrice : "가격" ,
		totalPrice : "가격"
	}
	function kakaopay (data) {
		$.ajax({
			type:'post',
			url:'/order/pay',
			data:{
				order_id : createOrderNum(),
				item_name : "[[${물건 이름 첫번째}]] 외 [[${총 개수}]] 개",
				total_amount: data.totalPayPrice,
				pay_user_name: data.name,
				total_price: data.totalPrice,
				tel: data.phone,
				email: data.email
			},
			success : 
				function(resData){
					location.href = resData;
				}
		})
		
	}
})


$('#iamportBtn').on('submit', function() {
	function iampayment() {
		const data = {
			orderNum : createOrderNum(),
			name : $("#iamportTest input[name='buyer_name']").val(),
			email : $("#iamportTest input[name='buyer_email']").val(),
			phone : $("#iamportTest input[name='buyer_tel']").val(),
			postcode : $("#iamportTest input[name='postcode']").val(),
			address : $("#iamportTest input[name='roadAddress']").val() + $("#iamportTest input[name='detailAddress']").val()
		}
		requestPay(data);
	}
	function requestPay() {
		IMP.init("imp34850056");
	    IMP.request_pay({
	      pg: "kcp",
	      pay_method: "card",
	      merchant_uid: createOrderNum(),   // 주문번호
	      name: "[[${물건 이름 첫번째}]] 외 [[${총 개수}]] 개",
	      amount: 10,   // 숫자 타입
	      buyer_email: data.email,
	      buyer_name: data.name,
	      buyer_tel: data.phone, 
	      buyer_addr: data.address,
	      buyer_postcode: data.postcode,
	    }, function (rsp) { 
	    	console.log(rsp);
	    	if ( rsp.success ) {
		    	var msg = '결제가 완료되었습니다.';
		        msg += '고유ID : ' + rsp.imp_uid;
		        msg += '상점 거래ID : ' + rsp.merchant_uid;
		        msg += '결제 금액 : ' + rsp.paid_amount;
		        msg += '카드 승인번호 : ' + rsp.apply_num;
		    } else {
		    	 var msg = '결제에 실패하였습니다.';
		         msg += '에러내용 : ' + rsp.error_msg;
		    }
		    alert(msg);
		});
	}
	
})

</script>
<body>
	<section class="container">
		<div class="prod_list">
			<table>
				<tbody>
					<!-- 이게 맞는 지 모르겠어요 ... 문법 확인 부탁드립니다... -->
					<th:block th:each=${장바구니}>
						<tr>
							<td colspan="2">{앨범사진}</td>
							<td>{앨범이름}</td>
						</tr>
						<tr>
							<td>{가수이름}</td>
						</tr>
						<tr>
							<td>{개수}</td>
						</tr>
					</th:block>
				</tbody>
			</table>
			<div>
				<span>총 가격</span>
				<span>{총 가격}</span>
			</div>
		</div>
		<div class="order_list">
			<div>주문하시는 분</div>
			<input type="text" name="buyer_name" value="${이름}">
			<input type="text" name="buyer_tel" value="${이메일}">
			<input type="text" name="buyer_email" value="${전화번호}">
			<form action="iamportTest">
				<div>받으시는 분</div>
				<!--  주문자와 받는 사람이 같은 경우 값이 자동으로 입력되도록 하기 -->
				<input type="button" value="주문자와 동일합니다" onclick="sameorder()">
				<!--  아닌 경우에는 각자 입력하도록 -->
				<label for="buyer_name">이름</label>
				<input type="text" id="buyer_name" placeholder="${session.name}">
				
				<label for="buyer_tel">전화번호</label>
				<input type="tel" name="buyer_tel" placeholder="${session.phoneNo}"> <!--  이게 가능한지모르겠어...  -->
				
				<label for="buyer_email">이메일</label>
				<input type="text" name="buyer_email">
				
				<label for="postcode">우편번호</label>
					<div class="button-group">
						<input type="text" onclick="execDaumPostcode()" name="postcode" id="postcode"  readonly="readonly">
						<input type="button" onclick="execDaumPostcode()" value="우편번호 검색">
					</div>
					<input type="text" name="roadAddress" id="buyer_addr" placeholder="도로명주소">
					<span id="guide" style="color:#999; display:none"></span>
					<input type="text" name="detailAddress" id="buyer_addr2" placeholder="상세주소">
				<button id="iamportBtn">일반결제하기</button>
				<button id="kakaopayBtn">카카오페이 결제하기</button>
			</form>
		</div>
	</section>
</body>
</html>